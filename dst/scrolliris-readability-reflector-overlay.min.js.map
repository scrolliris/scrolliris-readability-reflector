{"version":3,"sources":["scrolliris-readability-reflector-overlay.js"],"names":["e","t","n","r","s","o","u","a","require","i","f","Error","code","l","exports","call","length","1","module","_shadeColor","color","percent","parseInt","slice","p","R","G","B","Math","round","toString","Object","defineProperty","value","collectElements","article","selectors","q","forEach","d","key","querySelectorAll","getStyle","prop","currentStyle","window","getComputedStyle","document","defaultView","getPropertyValue","fetchResultData","endpointURL","csrfToken","resolveCallback","rejectCallback","credentials","url","emptyData","Promise","resolve","reject","xhr","XMLHttpRequest","open","setRequestHeader","responseType","onerror","status","onload","response","replace","JSON","parse","console","error","send","getJSON","then","data","buildHTML","elements","html","colors","pIndex","Array","from","map","importNode","nodeName","v","String","undefined","parseFloat","err","style","background","backgroundColor","outerHTML","join","2","_typeof","Symbol","iterator","obj","constructor","prototype","_util","win","doc","ctx","actions","result","action","run","layer","getElementById","position","y","x","setPosition","classList","contains","top","left","bottom","parent","pageYOffset","pageXOffset","MutationObserver","r_filtered","filter","m","attributeName","type","observe","attributes","addEventListener","path","w","pageY","pageX","settings","options","hasOwnProperty","config","querySelector","draw","offset","rect","getBoundingClientRect","newNode","padding","margin","fontFamily","fontSize","lineHeight","letterSpacing","right","width","height","innerHTML","ScrollirisReadabilityReflector","Context","./_util"],"mappings":"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","file":"scrolliris-readability-reflector-overlay.min.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nfunction _shadeColor(color, percent) {\n  var f = parseInt(color.slice(1), 16),\n      t = percent < 0 ? 0 : 255,\n      p = percent < 0 ? percent * -1 : percent;\n  var R = f >> 16,\n      G = f >> 8 & 0x00FF,\n      B = f & 0x0000FF;\n  return '#' + (0x1000000 + (Math.round((t - R) * p) + R) * 0x10000 + (Math.round((t - G) * p) + G) * 0x100 + (Math.round((t - B) * p) + B)).toString(16).slice(1);\n}\n\nfunction collectElements(article, selectors) {\n  var q = '';\n  [// default\n  ['heading', 'h1,h2,h3,h4,h5,h6'], ['paragraph', 'p']\n  //, ['sentence', '']  FIXME: sentence must be nested in p\n  , ['material', 'ul,ol,pre,table,blockquote']].forEach(function (d) {\n    var key = d[0];\n    q += ',' + (selectors[key] || d[1]);\n  });\n  return article.querySelectorAll(q.slice(1));\n}\n\nfunction getStyle(e, prop) {\n  var s = void 0;\n  if (e.currentStyle) {\n    s = e.currentStyle[prop];\n  } else if (window.getComputedStyle) {\n    s = document.defaultView.getComputedStyle(e, null).getPropertyValue(prop);\n  }\n  return s;\n}\n\nfunction fetchResultData(endpointURL, csrfToken, resolveCallback, rejectCallback) {\n  var credentials = { csrfToken: csrfToken };\n  if (!credentials.csrfToken) {\n    credentials.csrfToken = '';\n  }\n  var getJSON = function getJSON(url) {\n    var emptyData = { 'p': [] };\n    return new Promise(function (resolve, reject) {\n      var xhr = new XMLHttpRequest();\n      xhr.open('GET', url, true);\n      xhr.setRequestHeader('Accept', 'application/json');\n      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');\n      if (credentials.csrfToken !== '') {\n        xhr.setRequestHeader('X-CSRF-Token', credentials.csrfToken);\n      }\n      xhr.responseType = 'text';\n      xhr.onerror = function () {\n        var status = xhr.status;\n        reject(emptyData);\n      };\n      xhr.onload = function () {\n        var status = xhr.status,\n            response = xhr.response;\n        if (status === 200) {\n          response = response.replace(/^\\]\\)\\}while\\(1\\);<\\/x>/, '');\n          resolve(JSON.parse(response));\n        } else {\n          console.error('[ERROR] GET status: ', status);\n          reject(emptyData);\n        }\n      };\n      xhr.send();\n    });\n  };\n  return getJSON(endpointURL).then(function (data) {\n    return resolveCallback(data);\n  }, function (data) {\n    return rejectCallback(data);\n  });\n}\n\nfunction buildHTML(data, elements) {\n  var html = '<html><head>';\n  html += '\\n<style>\\n</style>\\n';\n  // additional styles\n  // html += Array.from([]).map((s) => {\n  //   return s.outerHTML;\n  // }).join('');\n  html += '</head><body>';\n\n  var colors0 = [// heatmap 11\n  '#2d96db', '#4aa8a6', '#64b977', '#99c95d', '#c5d062', '#f6d866', '#fab252', '#fd8e3e', '#fe6f43', '#fd515b', '#fb1b2a'];\n\n  var colors1 = [// pastel 12\n  '#9e0142', '#d0384d', '#ee6445', '#fa9c58', '#fdcd7b', '#fef0a7', '#f3faad', '#d0ec9c', '#98d5a4', '#5cb7a9', '#3582ba', '#5e4fa2'];\n\n  var colors = colors0 // heatmap (for now)\n  ,\n      pIndex = 0;\n  html += Array.from(elements).map(function (e) {\n    var n = document.importNode(e, true);\n    if (n.nodeName !== 'IMG') {\n      if (n.nodeName === 'P' && 'p' in data) {\n        // BETA only paragraph support\n        var v = data['p'][String(pIndex)];\n        if (v !== undefined) {\n          var color = '#ffffff';\n          try {\n            var i = Math.round(parseFloat(v) * 10);\n            color = _shadeColor(colors[i], 0.55);\n          } catch (err) {\n            console.error(err);\n          }\n          n.style.background = color;\n          n.style.backgroundColor = 'rgba(' + color + ', 0.9)';\n        }\n        pIndex += 1;\n      }\n    }\n    return n.outerHTML;\n  }).join('');\n  html += '</body></html>';\n  return html;\n}\n\nexports.collectElements = collectElements;\nexports.getStyle = getStyle;\nexports.fetchResultData = fetchResultData;\nexports.buildHTML = buildHTML;\n\n},{}],2:[function(require,module,exports){\n'use strict';\n\nvar _typeof = typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; };\n\nvar _util = require('./_util');\n\n(function (win, doc, ctx) {\n  var layElements = function layElements() {\n    /**\n     * Renders elements which has colored background based on received data\n     * into `overlay_container`\n     *\n     * Invokes a async fetch request to API server.\n     */\n    var config = {},\n        settings = {},\n        options = {};\n\n    if (ctx.hasOwnProperty('config') && _typeof(ctx.config) === 'object') {\n      config = ctx['config'];\n      // pass\n    }\n    if (ctx.hasOwnProperty('settings') && _typeof(ctx.options) === 'object') {\n      settings = ctx['settings'];\n      if (!settings.endpointURL) {\n        console.error('endpointURL is required');\n        return false;\n      }\n    }\n    if (ctx.hasOwnProperty('options') && _typeof(ctx.options) === 'object') {\n      options = ctx['options'];\n    }\n\n    var selectors = options.selectors || {};\n    var article = win.parent.document.querySelector(selectors.article || 'body article');\n\n    // collect elements\n    var elements = (0, _util.collectElements)(article, selectors);\n\n    var draw = function draw(data) {\n      var offset = {\n        x: win.parent.pageXOffset,\n        y: win.parent.pageYOffset\n      };\n\n      var html = (0, _util.buildHTML)(data, Array.from(elements).map(function (e) {\n        var rect = e.getBoundingClientRect();\n        var newNode = doc.importNode(e, true);\n        if (!newNode) {\n          return e;\n        } else {\n          // set position\n          newNode.style.padding = '0';\n          newNode.style.margin = '0';\n\n          newNode.style.fontFamily = (0, _util.getStyle)(e, 'font-family');\n          newNode.style.fontSize = (0, _util.getStyle)(e, 'font-size');\n          newNode.style.lineHeight = (0, _util.getStyle)(e, 'line-height');\n          newNode.style.letterSpacing = (0, _util.getStyle)(e, 'letter-spacing');\n\n          newNode.style.position = 'absolute';\n          newNode.style.top = rect.top + offset.y + 'px';\n          newNode.style.left = rect.left + offset.x + 'px';\n          newNode.style.right = rect.right + 'px';\n          newNode.style.width = rect.width + 'px';\n          newNode.style.height = rect.height + 'px';\n\n          // additional\n          newNode.style.color = 'transparent';\n          return newNode;\n        }\n      }));\n\n      var container = doc.getElementById('scrolliris_overlay_container');\n      container.innerHTML = html;\n    };\n\n    (0, _util.fetchResultData)(settings.endpointURL, settings.csrfToken, function (data) {\n      // resolve\n      draw(data);\n    }, function (data) {\n      // reject\n      // FIXME\n      draw(data);\n    });\n  };\n\n  var putLayer = function putLayer() {\n    /**\n     * Sets layer position by scroll event and toggle button click.\n     *\n     * Puts `item_container` to valid position.\n     */\n    var layer = doc.getElementById('scrolliris_item_container');\n\n    var position = { // initial position\n      y: 0,\n      x: 0\n    };\n\n    var setPosition = function setPosition(y, x) {\n      if (!layer.classList.contains('hidden')) {\n        layer.style.top = position.y - y + 'px';\n        layer.style.left = position.x - x + 'px';\n      } else {\n        layer.style.top = '';\n        layer.style.left = '';\n        layer.style.bottom = '0';\n      }\n    };\n\n    // at rendering time (avoid layout flashing)\n    setPosition(win.parent.pageYOffset, win.parent.pageXOffset);\n\n    // an observer for the change class `.hidden` toggling\n    var callback = function callback(r) {\n      // get only a target mutation record\n      var r_filtered = r.filter(function (m) {\n        return m.attributeName === 'class';\n      });\n      if (r_filtered.length !== 1) {\n        return;\n      }\n      var m = r_filtered[0];\n      if (m.type === 'attributes' && m.attributeName === 'class') {\n        // parent page offset values\n        setPosition(win.parent.pageYOffset, win.parent.pageXOffset);\n      }\n    };\n    var observer = new MutationObserver(callback);\n    observer.observe(layer, { attributes: true });\n\n    // synchronize with the scroll event on parent document\n    win.parent.document.addEventListener('scroll', function (e) {\n      // TODO: check more browsers\n      if ('path' in e) {\n        // chromium\n        if (e.path.length !== 2) {\n          return;\n        }\n        var w = e.path[1];\n        setPosition(w.pageYOffset, e.pageXOffset);\n      } else {\n        // firefox\n        setPosition(e.pageY, e.pageX);\n      }\n    });\n  };\n\n  var run = function run(actions) {\n    var result = Promise.resolve();\n    actions.forEach(function (action) {\n      result = result.then(function () {\n        return action();\n      });\n    });\n    return result;\n  };\n\n  run([putLayer, layElements]);\n})(window, document, (window.ScrollirisReadabilityReflector || {}).Context);\n\n},{\"./_util\":1}]},{},[2]);\n"]}